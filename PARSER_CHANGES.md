# Изменения в парсере документов

## Что было сделано

### 1. Установлены новые библиотеки
- **pdf2json@3.1.4** - для парсинга PDF файлов (стабильно работает в Next.js)
- **mammoth** - для парсинга DOCX файлов

### 2. Обновлен парсер PDF (`utils/cpParser.ts`)
- Заменили `pdf-parse` на `pdf2json` из-за проблем с webpack в Next.js
- `pdf2json` правильно извлекает текст из PDF и работает стабильно
- Добавлена декодировка URI-encoded текста

### 3. Добавлена поддержка Word документов
- Реализован парсинг DOCX файлов с помощью `mammoth`
- Поддерживаются форматы: `.docx` и `.doc`

### 4. Обновлен API обработки документов
- `app/api/whatsapp/webhook/process-document/route.ts` теперь поддерживает:
  - PDF файлы (`application/pdf`)
  - Word документы (`application/vnd.openxmlformats-officedocument.wordprocessingml.document`)
  - Универсальная функция `downloadAndParseDocument` для обоих типов

### 5. Исправлена конфигурация
- `.env.local`: исправлен `NEXT_PUBLIC_APP_URL` с `http://localhost:3001` на `http://localhost:3000`

## Как это работает

1. **Webhook получает документ** → `app/api/whatsapp/webhook/route.ts`
2. **Определяется тип файла** (PDF/DOCX)
3. **Документ скачивается** через Whapi API
4. **Извлекается текст**:
   - PDF: `pdf2json` → декодирование → очистка
   - DOCX: `mammoth` → извлечение текста
5. **Текст отправляется в OpenAI** для структурированного парсинга
6. **Создается коммерческое предложение** в базе данных

## Тестирование

Протестировано на реальном PDF файле (142KB, 2 страницы):
- ✅ Извлечение текста работает
- ✅ OpenAI парсинг работает
- ✅ Сохранение в БД работает

## Поддерживаемые форматы

- ✅ PDF (`.pdf`)
- ✅ Word (`.docx`, `.doc`)
- ⚠️ Изображения в PDF не поддерживаются (требуется OCR)

## Следующие шаги

Для улучшения парсинга можно добавить:
1. OCR для PDF с изображениями (Tesseract.js)
2. Парсинг таблиц из Excel
3. Улучшенная обработка сложных форматов

