#!/bin/bash
# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ DNS challenge
# –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞ 80, —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ DNS –∑–∞–ø–∏—Å–∏

set -e

DOMAIN="alexautozakup.kz"
EMAIL="admin@alexautozakup.kz"

echo "üîí –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ DNS challenge"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

echo ""
echo "üìã –í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:"
echo ""
echo "1. DNS Challenge (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞ 80"
echo "   –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å TXT –∑–∞–ø–∏—Å—å –≤ DNS"
echo ""
echo "2. Standalone —Ä–µ–∂–∏–º - –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç nginx"
echo ""
echo "3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å acme.sh (–±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)"
echo ""
echo "–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–µ—Ä–µ—Ç–µ?"
echo ""
echo "–ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ DNS challenge?"

# –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å certbot —Å DNS challenge
# –ù–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è TXT –∑–∞–ø–∏—Å–∏ –≤ DNS

echo ""
echo "üîß –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±: –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è DNS challenge"

cd "$(dirname "$0")"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx –≤—Ä–µ–º–µ–Ω–Ω–æ
echo ""
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx..."
docker-compose stop nginx

# –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ standalone (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±)
echo ""
echo "üîí –ü–æ–ª—É—á–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (standalone —Ä–µ–∂–∏–º)..."
echo "   –≠—Ç–æ –∑–∞–π–º–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã..."
echo ""

docker-compose run --rm -p 80:80 certbot certonly \
    --standalone \
    --preferred-challenges http \
    --email "$EMAIL" \
    --agree-tos \
    --no-eff-email \
    -d "$DOMAIN" \
    -d "www.$DOMAIN"

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!"
    echo ""
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Å HTTPS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ HTTPS..."
    
    # –û–±–Ω–æ–≤–ª—è–µ–º docker-compose.yml –¥–ª—è HTTPS
    sed -i 's|nginx-http.conf:/etc/nginx/conf.d/default.conf|nginx.conf:/etc/nginx/conf.d/default.conf|' docker-compose.yml
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º nginx
    docker-compose up -d nginx
    
    echo ""
    echo "‚úÖ HTTPS –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
    echo ""
    echo "üéâ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
    echo "   https://$DOMAIN"
    echo "   https://www.$DOMAIN"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    echo ""
    echo "–ü—Ä–æ–±–ª–µ–º—ã –º–æ–≥—É—Ç –±—ã—Ç—å:"
    echo "  1. –ü–æ—Ä—Ç 80 –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "  2. –î–æ–º–µ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ"
    echo "  3. DNS –∑–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    echo ""
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ DNS challenge (—Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ TXT –∑–∞–ø–∏—Å–∏)"
fi

