#!/bin/bash
# –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx –∏ –ø–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ standalone —Ä–µ–∂–∏–º

set -e

DOMAIN="alexautozakup.kz"
EMAIL="admin@alexautozakup.kz"

echo "üîí –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (standalone —Ä–µ–∂–∏–º)"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

cd "$(dirname "$0")"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞
echo ""
echo "üìå –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞..."
if curl -s -o /dev/null -w "%{http_code}" http://$DOMAIN | grep -q "200\|301\|302\|307"; then
    echo "‚úÖ –î–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è  –î–æ–º–µ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DNS –∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx –≤—Ä–µ–º–µ–Ω–Ω–æ (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 80)
echo ""
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx..."
docker-compose stop nginx

# –ñ–¥–µ–º, —á—Ç–æ–±—ã –ø–æ—Ä—Ç —Ç–æ—á–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏–ª—Å—è
sleep 2

# –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo ""
echo "üîí –ü–æ–ª—É—á–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç Let's Encrypt..."
echo "   –≠—Ç–æ –∑–∞–π–º–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã..."
echo ""

docker-compose run --rm -p 80:80 certbot certonly \
    --standalone \
    --preferred-challenges http \
    --email "$EMAIL" \
    --agree-tos \
    --no-eff-email \
    --force-renewal \
    -d "$DOMAIN" \
    -d "www.$DOMAIN"

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!"
    echo ""
    
    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º nginx –Ω–∞ HTTPS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ HTTPS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
    
    # –û–±–Ω–æ–≤–ª—è–µ–º docker-compose.yml
    sed -i 's|nginx-http.conf:/etc/nginx/conf.d/default.conf|nginx.conf:/etc/nginx/conf.d/default.conf|' docker-compose.yml
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º nginx –æ–±—Ä–∞—Ç–Ω–æ
    echo ""
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º nginx —Å HTTPS..."
    docker-compose up -d nginx
    
    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
    sleep 3
    
    echo ""
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
    echo ""
    echo "üéâ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω:"
    echo "   https://$DOMAIN"
    echo "   https://www.$DOMAIN"
    echo ""
    echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞:"
    echo "   curl -I https://$DOMAIN"
    echo ""
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  ‚Ä¢ –ü–æ—Ä—Ç 80 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ: netstat -tlnp | grep :80)"
    echo "  ‚Ä¢ –î–æ–º–µ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ DNS)"
    echo "  ‚Ä¢ Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ä—Ç 80"
    echo ""
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º nginx –æ–±—Ä–∞—Ç–Ω–æ
    docker-compose up -d nginx
    
    echo "üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ DNS challenge (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Ä—Ç–∞ 80)"
    exit 1
fi

