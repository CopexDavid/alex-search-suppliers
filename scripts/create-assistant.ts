// –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è OpenAI Assistant "–°–∞–Ω–∂–∞—Ä"
import OpenAI from 'openai'
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function createSanzharAssistant() {
  try {
    console.log('ü§ñ –°–æ–∑–¥–∞–µ–º OpenAI Assistant "–°–∞–Ω–∂–∞—Ä"...')

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Assistants v2
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
      defaultHeaders: {
        'OpenAI-Beta': 'assistants=v2'
      }
    })

    if (!process.env.OPENAI_API_KEY) {
      throw new Error('OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è')
    }

    // –°–æ–∑–¥–∞–µ–º Assistant —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –¥–ª—è v2
    const assistant = await openai.beta.assistants.create({
      name: "–°–∞–Ω–∂–∞—Ä - –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∑–∞–∫—É–ø–∫–∞–º",
      instructions: `
–¢—ã - –°–∞–Ω–∂–∞—Ä, –æ–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∑–∞–∫—É–ø–∫–∞–º –∫–æ–º–ø–∞–Ω–∏–∏ –¢–û–û "Alex" –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ.

–¢–í–û–Ø –ì–õ–ê–í–ù–ê–Ø –¶–ï–õ–¨: –ü–æ–ª—É—á–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —á–µ—Ä–µ–∑ WhatsApp –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã.

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä
- –ì–æ–≤–æ—Ä–∏—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–º —Å—Ç–∏–ª–µ –¥–ª—è WhatsApp
- –ó–Ω–∞–µ—à—å –º–µ—Å—Ç–Ω—ã–π —Ä—ã–Ω–æ–∫ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–µ–¥–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ
- –£–º–µ–µ—à—å —Ç–æ—Ä–≥–æ–≤–∞—Ç—å—Å—è –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- –í—Å–µ–≥–¥–∞ –≤–µ–∂–ª–∏–≤, –Ω–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤ –≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–π

–°–¢–†–ê–¢–ï–ì–ò–Ø –ü–ï–†–ï–ì–û–í–û–†–û–í:
1. üéØ –ì–õ–ê–í–ù–û–ï: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ü–µ–Ω–∞–º–∏, —Å—Ä–æ–∫–∞–º–∏, —É—Å–ª–æ–≤–∏—è–º–∏
2. üí¨ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –∂–∏–≤–æ–π –¥–∏–∞–ª–æ–≥, –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
3. üí∞ –ò–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è —Å–∫–∏–¥–∫–∞–º–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö
4. üöö –£—Ç–æ—á–Ω—è–π —Å—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏ –∏ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
5. üí≥ –í—ã—è—Å–Ω—è–π —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, –æ—Ç—Å—Ä–æ—á–∫–∞)
6. üìã –ó–∞–ø—Ä–∞—à–∏–≤–∞–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
7. ü§ù –°–æ–∑–¥–∞–≤–∞–π –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –Ω–∞–¥–µ–∂–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å WhatsApp (–∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è,)
- –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "–í—ã" –∫ –Ω–æ–≤—ã–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º, –Ω–∞ "—Ç—ã" –∫ –∑–Ω–∞–∫–æ–º—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Å—Ç–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è: "–ö–∞–∫ –¥–µ–ª–∞?", "–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", "–ñ–¥—É –æ—Ç–≤–µ—Ç–∞"
- –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø–æ –¥–µ–ª—É

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ù—É–∂–Ω–æ –º–∞—Å–ª–æ –º–æ—Ç–æ—Ä–Ω–æ–µ 200–ª. –ö–∞–∫–∏–µ —Ü–µ–Ω—ã? üöó"
- "–û—Ç–ª–∏—á–Ω–æ! –ê –∫–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏? –ó–∞—è–≤–∫–∞ —Å—Ä–æ—á–Ω–∞—è ‚è∞"
- "–•–æ—Ä–æ—à–æ. –ï—Å—Ç—å —Å–∫–∏–¥–∫–∏ –æ—Ç 500–ª? –û–±—ä–µ–º—ã –±–æ–ª—å—à–∏–µ üìà"
- "–ü–æ–Ω—è–ª. –ñ–¥—É –ö–ü –Ω–∞ –ø–æ—á—Ç—É –∏–ª–∏ –º–æ–∂–µ—Ç–µ –∑–¥–µ—Å—å –ø—Ä–∏—Å–ª–∞—Ç—å? üìß"
- "–°–ø–∞—Å–∏–±–æ! –†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∏ —Å–≤—è–∂–µ–º—Å—è. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! üëç"

–ß–¢–û –ù–ï –î–ï–õ–ê–¢–¨:
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è ("–£–≤–∞–∂–∞–µ–º—ã–π...")
- –ù–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
- –ù–µ —Å–æ–≥–ª–∞—à–∞–π—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é —Ü–µ–Ω—É –±–µ–∑ —Ç–æ—Ä–≥–∞
- –ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ –≥–ª–∞–≤–Ω—É—é —Ü–µ–ª—å - –ø–æ–ª—É—á–∏—Ç—å –ö–ü

–ö–û–ù–¢–ï–ö–°–¢ –ó–ê–Ø–í–ö–ò:
–¢—ã –≤—Å–µ–≥–¥–∞ –∑–Ω–∞–µ—à—å:
- –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏
- –ö–∞–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω—É–∂–Ω—ã (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –µ–¥–∏–Ω–∏—Ü—ã)
- –ë—é–¥–∂–µ—Ç –∏ –¥–µ–¥–ª–∞–π–Ω—ã
- –ò—Å—Ç–æ—Ä–∏—é –æ–±—â–µ–Ω–∏—è —Å –∫–∞–∂–¥—ã–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º

–û–°–û–ë–ï–ù–ù–û–°–¢–ò –ö–ê–ó–ê–•–°–¢–ê–ù–°–ö–û–ì–û –†–´–ù–ö–ê:
- –í–∞–ª—é—Ç–∞: —Ç–µ–Ω–≥–µ (KZT), –¥–æ–ª–ª–∞—Ä—ã (USD)
- –ù–î–°: 12% (—É—Ç–æ—á–Ω—è–π –≤–∫–ª—é—á–µ–Ω –ª–∏ –≤ —Ü–µ–Ω—É)
- –î–æ—Å—Ç–∞–≤–∫–∞: –æ–±—ã—á–Ω–æ –¥–æ —Å–∫–ª–∞–¥–∞ –≤ –ê–ª–º–∞—Ç—ã
- –û–ø–ª–∞—Ç–∞: —á–∞—Å—Ç–æ —Ç—Ä–µ–±—É—é—Ç –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É 50-100%
- –î–æ–∫—É–º–µ–Ω—Ç—ã: –Ω—É–∂–Ω—ã —Å—á–µ—Ç–∞, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

–ü–æ–º–Ω–∏: —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å —Å–µ—Ä—å–µ–∑–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º–∏ –æ–±—ä–µ–º–∞–º–∏ –∑–∞–∫—É–ø–æ–∫!
`,
      model: "gpt-4o-mini",
      tools: [
        {
          type: "function",
          function: {
            name: "get_request_info",
            description: "–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–µ –∏ –ø–æ–∑–∏—Ü–∏—è—Ö",
            parameters: {
              type: "object",
              properties: {
                requestId: {
                  type: "string",
                  description: "ID –∑–∞—è–≤–∫–∏"
                }
              },
              required: ["requestId"]
            }
          }
        },
        {
          type: "function",
          function: {
            name: "save_supplier_info",
            description: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–µ (—Ü–µ–Ω—ã, —É—Å–ª–æ–≤–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã)",
            parameters: {
              type: "object",
              properties: {
                supplierId: {
                  type: "string",
                  description: "ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"
                },
                info: {
                  type: "object",
                  description: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–µ",
                  properties: {
                    prices: { type: "string" },
                    delivery_terms: { type: "string" },
                    payment_terms: { type: "string" },
                    notes: { type: "string" }
                  }
                }
              },
              required: ["supplierId", "info"]
            }
          }
        }
      ],
      temperature: 0.7,
      top_p: 1.0
    })

    console.log(`‚úÖ Assistant —Å–æ–∑–¥–∞–Ω: ${assistant.id}`)
    console.log(`üìù –ò–º—è: ${assistant.name}`)

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID Assistant –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    await prisma.systemSetting.upsert({
      where: { key: 'openai_assistant_id' },
      update: {
        value: assistant.id,
        type: 'string',
        updatedAt: new Date()
      },
      create: {
        key: 'openai_assistant_id',
        value: assistant.id,
        type: 'string'
      }
    })

    console.log(`üíæ Assistant ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${assistant.id}`)

    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π thread
    const thread = await openai.beta.threads.create({
      metadata: {
        supplier: "test_supplier",
        request_id: "test_request"
      }
    })

    console.log(`üßµ –¢–µ—Å—Ç–æ–≤—ã–π thread —Å–æ–∑–¥–∞–Ω: ${thread.id}`)

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º Assistant
    console.log('\nüß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º Assistant...')
    
    const message = await openai.beta.threads.messages.create(thread.id, {
      role: "user",
      content: "–ü—Ä–∏–≤–µ—Ç! –£ –Ω–∞—Å –µ—Å—Ç—å –∑–∞—è–≤–∫–∞ –Ω–∞ –º–æ—Ç–æ—Ä–Ω–æ–µ –º–∞—Å–ª–æ 200 –ª–∏—Ç—Ä–æ–≤. –ú–æ–∂–µ—Ç–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å?"
    })

    const run = await openai.beta.threads.runs.create(thread.id, {
      assistant_id: assistant.id
    })

    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    let runStatus = await openai.beta.threads.runs.retrieve(thread.id, run.id)
    while (runStatus.status === 'running' || runStatus.status === 'queued') {
      await new Promise(resolve => setTimeout(resolve, 1000))
      runStatus = await openai.beta.threads.runs.retrieve(thread.id, run.id)
      console.log(`‚è≥ –°—Ç–∞—Ç—É—Å: ${runStatus.status}`)
    }

    if (runStatus.status === 'completed') {
      const messages = await openai.beta.threads.messages.list(thread.id)
      const assistantMessage = messages.data[0]
      
      if (assistantMessage.role === 'assistant' && assistantMessage.content[0].type === 'text') {
        console.log('\n‚úÖ –û—Ç–≤–µ—Ç –°–∞–Ω–∂–∞—Ä–∞:')
        console.log(`"${assistantMessage.content[0].text.value}"`)
      }
    } else {
      console.log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${runStatus.status}`)
      if (runStatus.last_error) {
        console.log(`–î–µ—Ç–∞–ª–∏: ${runStatus.last_error.message}`)
      }
    }

    console.log('\nüéâ Assistant "–°–∞–Ω–∂–∞—Ä" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω!')
    console.log(`üîë ID –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: ${assistant.id}`)

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Assistant:', error)
  } finally {
    await prisma.$disconnect()
  }
}

createSanzharAssistant()
